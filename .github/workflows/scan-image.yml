name: Scan Docker Image

on:
  repository_dispatch:
    types: [docker-image-pushed]

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Pull Docker image
        run: docker pull ${{ github.event.client_payload.image }}

      - name: Scan image with Trivy
        id: trivy_scan
        continue-on-error: true
        run: |
          echo "üîç Starting vulnerability scan for image: ${{ github.event.client_payload.image }}"
          trivy image \
            --exit-code 1 \
            --severity CRITICAL,HIGH \
            --format table \
            ${{ github.event.client_payload.image }} | tee trivy-results.txt
          
          # Set the exit code as an output variable
          echo "trivy_status=$?" >> $GITHUB_OUTPUT

      - name: Show scan result summary
        run: |
          if [ "${{ steps.trivy_scan.outputs.trivy_status }}" != "0" ]; then
            echo "‚ùå Trivy scan failed: vulnerabilities found."
            echo "üìã Showing summary:"
            cat trivy-results.txt
          else
            echo "‚úÖ Trivy scan passed: no critical/high vulnerabilities found."
          fi

      - name: Delete image from DockerHub if vulnerabilities are found
        if: steps.trivy_scan.outputs.trivy_status != '0'
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "üóëÔ∏è Deleting insecure Docker image from DockerHub..."
          # Parse the image name and tag
          IMAGE_FULL="${{ github.event.client_payload.image }}"
          IMAGE_NAME=$(echo $IMAGE_FULL | cut -d':' -f1)
          IMAGE_TAG=$(echo $IMAGE_FULL | cut -d':' -f2)
          
          # Log in to DockerHub
          echo $DOCKERHUB_TOKEN | docker login -u $DOCKERHUB_USERNAME --password-stdin
          
          # Delete the image using the DockerHub API
          REPO_NAME=$(echo $IMAGE_NAME | cut -d'/' -f2-)
          curl -X DELETE \
            -H "Authorization: JWT $DOCKERHUB_TOKEN" \
            "https://hub.docker.com/v2/repositories/${REPO_NAME}/tags/${IMAGE_TAG}/"
          
          echo "Image deleted from DockerHub successfully."